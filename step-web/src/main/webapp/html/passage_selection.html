<div class="modal-header">
	<button id="pssgModalBackButton" type="button" style="border:none;float:left;font-size:16px" onclick=goBackToPreviousPage()><i class="glyphicon glyphicon-arrow-left"></i></button>
	<button type="button" class="close" data-dismiss="modal" onclick=closeChapterSelect()>X</button>
</div>
<div id="bookchaptermodalbody" class="modal-body">
</div>
<div class="footer">
	<a id="keyboardEntry" href="javascript:_userEnterPassage();">
		<img src="/images/keyboard.jpg" alt="Keyboard entry">
		<span>Type in the passage (optional)</span>
	</a>
</div>
<script>
    var version = "ESV_th";
    var userLang = "en";
    var addInsteadOfReplace = false;
	var lastInput = "";
	var lastInputChecked = "";
    $(document).ready(function () {
        userLang = step.state.language() || "en-US";
        _displayListOfBooks();
    });

	function _displayListOfBooks() {
        var html = _buildBookHeaderAndSkeleton();
        $('#bookchaptermodalbody').append(html);
        $('#keyboardEntry').show();
		_buildBookTable();
        $('#pssgModalBackButton').hide();
    }

	function _buildBookTable() {
        var translationType = _getTranslationType();
        if ((userLang.toLowerCase().startsWith("en") || userLang.toLowerCase().startsWith("es") || userLang.toLowerCase().startsWith("zh")) &&
            (translationType !== "")) {
            _buildBookHTMLTable(translationType);
        }
        else {
            var url = SEARCH_AUTO_SUGGESTIONS + "%20%20/" + EXAMPLE_DATA + "%3D" + REFERENCE + "%7C" + LIMIT + "%3D" + REFERENCE + "%7C" + VERSION + "%3D" + version + "%7C?lang=" + userLang;
            $.getJSON(url, function (data) {
                _buildBookHTMLTable(data);
            });
        }	
	}

	function _getTranslationType() {
		var versionAltName = '';
		var data = step.util.activePassage().get("searchTokens") || [];
        for (var i = 0; i < data.length; i++) {
            if (data[i].itemType == VERSION) {
                version = data[i].item.initials;
                versionAltName = data[i].item.shortInitials;
                break;
            }
        }
		var translationsWithPopularBooksChapters = " niv esv nasb nasb_th nav sparv sparv1909 cun cuns chincvs abp abpgrk acv akjv alb arasvd asmulb asv bbe benulb bsb bulprotrev burjudson ccb clarke cro cym czebkr dan dan1871 darby dtn dutkant dutsvv esperanto fcb finbiblia finpr frebbb frecrl fremartin frepgr gen gerelb1871 gerelb1905 gergruenewald gersch gujulb haitian hcsb hinulb hnv hrvcb hunkar icelandic itadio itarive jfb jub kanulb kjv korhkjv korrv lbla luther mal1865 malulb maori marulb mhc mhcc nbla ndebele neno netfull nhe nhj nhm norsk norsmb ntlr nvi oriulb panulb pnvi polgdanska porar romcor roth rskj rwebs scofield serdke shona sparvg spasev swe1917 swekarlxii1873 tagangbiblia tamulb telulb tglulb tsk ukjv ukrainian umgreek urdulb viet vulgj web webb webm webs ylt ";
        var translationsWithPopularNTBooksChapters = ' 20c abbott ant armwestern barnes bashautin burkitt bwe byz cebulb che1860 comm copsahhorner copsahidica copsahidicmss diag ee elz eth family godb hauulb indulb khmkcb latvian leb lo mont murd nepulb nestle pesh pltulb pnt portb rkjn rwp sblg sblgntapp spavnt swahili swaulb thgnt tisch tnt tr ukrkulish uma varapp weym whnu wors ';
        var translationsWithPopularOTBooksChapters = ' ab gertextbibel kd wlc lees lxx rusmakarij ';
        var lowerCaseVersion = ' ' + version.toLowerCase() + ' ';
        versionAltName = ' ' + versionAltName.toLowerCase() + ' ';
        var translationType = "";
        if ((translationsWithPopularBooksChapters.indexOf(lowerCaseVersion) > -1) || (translationsWithPopularBooksChapters.indexOf(versionAltName) > -1)) translationType = "OTNT";
        else if ((translationsWithPopularNTBooksChapters.indexOf(lowerCaseVersion) > -1) || (translationsWithPopularNTBooksChapters.indexOf(versionAltName) > -1)) translationType = "NT";
        else if ((translationsWithPopularOTBooksChapters.indexOf(lowerCaseVersion) > -1) || (translationsWithPopularOTBooksChapters.indexOf(versionAltName) > -1)) translationType = "OT";
		return translationType;		
	}
	
    function _buildBookHTMLTable(data) {
        var ot = "Gen Exod Lev Num Deut Josh Judg Ruth 1Sam 2Sam 1Kgs 2Kgs 1Chr 2Chr Ezra Neh Esth Job Ps Prov Eccl Song Isa Jer Lam Ezek Dan Hos Joel Amos Obad Jonah Mic Nah Hab Zeph Hag Zech Mal";
        var nt = "Matt Mark Luke John Acts Rom 1Cor 2Cor Gal Eph ﻿Phil Col 1Thess 2Thess 1Tim 2Tim Titus Phlm Heb Jas 1Pet 2Pet 1John 2John 3John Jude Rev";
        var osisChapterJsword = [ // Array of OSIS id, number of chapters in the book and the JSword name (if it is different from OSIS id
            ["Gen", 50],
            ["Exo", 40, "Exod"],
            ["Lev", 27],
            ["Num", 36],
            ["Deu", 34, "Deut"],
            ["Jos", 24, "Josh"],
            ["Judg", 21],
            ["Rut", 4, "Ruth"],
            ["1Sa", 31, "1Sam"],
            ["2Sa", 24, "2Sam"],
            ["1Ki", 22, "1Kgs"],
            ["2Ki", 25, "2Kgs"],
            ["1Ch", 29, "1Chr"],
            ["2Ch", 36, "2Chr"],
            ["Ezr", 10, "Ezra"],
            ["Neh", 13],
            ["Est", 10, "Esth"],
            ["Job", 42],
            ["Psa", 150, "Ps"],
            ["Pro", 31, "Prov"],
            ["Ecc", 12, "Eccl"],
            ["Song", 8],
            ["Isa", 66],
            ["Jer", 52],
            ["Lam", 5],
            ["Eze", 48, "Ezek"],
            ["Dan", 12],
            ["Hos", 14],
            ["Joe", 3, "Joel"],
            ["Amo", 9, "Amos"],
            ["Obd", 1, "Obad"],
            ["Jon", 4, "Jonah"],
            ["Mic", 7],
            ["Nah", 3],
            ["Hab", 3],
            ["Zep", 3, "Zeph"],
            ["Hag", 2],
            ["Zec", 14, "Zech"],
            ["Mal", 4],
            ["Mat", 28, "Matt"],
            ["Mar", 16, "Mark"],
            ["Luk", 24, "Luke"],
            ["Joh", 21, "John"],
            ["Act", 28, "Acts"],
            ["Rom", 16],
            ["1Cor", 16],
            ["2Cor", 13],
            ["Gal", 6],
            ["Eph", 6],
            ["Phili", 4, "Phil"],
            ["Col", 4],
            ["1Th", 5, "1Thess"],
            ["2Th", 3, "2Thess"],
            ["1Ti", 6, "1Tim"],
            ["2Ti", 4, "2Tim"],
            ["Tit", 3, "Titus"],
            ["Phile", 1, "Phlm"],
            ["Heb", 13],
            ["Jam", 5, "Jas"],
            ["1Pe", 5, "1Pet"],
            ["2Pe", 3, "2Pet"],
            ["1Jo", 5, "1John"],
            ["2Jo", 1, "2John"],
            ["3Jo", 1, "3John"],
            ["Jude", 1],
            ["Rev", 22]
        ];
        var counter = 0;
        var notSeenNT = true;
        var browserWidth = $(window).width();
        var columns = 7;
        if (browserWidth < 1100) {
            columns = 6;
            if (browserWidth < 800) columns = 5;
        }
        var tableHTML = __buildBookTableHeader(columns);
        var typlicalBooksChapters = false;
        var arrayOfTyplicalBooksChapters;
        var start = 0;
        var end = 0;
        if (typeof data === "string") {
            if (data == "OTNT") end = 66;
            else if (data == "OT") end = 39;
            else if (data == "NT") {
                start = 39;
                end = 66;
            }
            data = osisChapterJsword;
            typlicalBooksChapters = true;
            arrayOfTyplicalBooksChapters = JSON.parse(__s.list_of_bibles_books);
        }
        else {
            end = data.length;
        }
        var additionalBooks = false;
        for (var i = start; i < end; i++) {
            var currentOsisID;
            var shortNameToDisplay;
            var longNameToDisplay;
            var numOfChapters;
            var jSwordName;
            if (typlicalBooksChapters) {
                currentOsisID = (data[i].length === 3) ? data[i][2] : data[i][0];
                numOfChapters = data[i][1];
                longNameToDisplay = arrayOfTyplicalBooksChapters[i][0];
                shortNameToDisplay = (arrayOfTyplicalBooksChapters[i].length === 2) ? arrayOfTyplicalBooksChapters[i][1] : currentOsisID;
            }
            else {
                currentOsisID = data[i].suggestion.osisID;
                numOfChapters = 0; // don't know yet, need to find out
                longNameToDisplay = data[i].suggestion.fullName;
                shortNameToDisplay = (userLang.toLowerCase().startsWith("en")) ? currentOsisID : data[i].suggestion.shortName.replaceAll(" ", "").substr(0, 6);
            }
            var newTestament;
            var oldTestment = false;
            newTestament = (nt.indexOf(currentOsisID) > -1);
            if (!newTestament) oldTestament = (ot.indexOf(currentOsisID) > -1);
            if (!newTestament && !oldTestament) {
                shortNameToDisplay += '<span style="color:brown">*</span>';
                additionalBooks = true;
            }
            if ((newTestament) && (notSeenNT)) {
                notSeenNT = false;
                counter = 0; // reset counter for NT table
                tableHTML += '</tr></table>';
                $('#ot_table').append(tableHTML);
                tableHTML = __buildBookTableHeader(columns);
            }
			if ((longNameToDisplay.length > 0) && (longNameToDisplay.length < 6)) shortNameToDisplay = longNameToDisplay;
            tableHTML += '<td title="' + longNameToDisplay + '">' +
                '<a href="javascript:getChapters(\'' + currentOsisID + '\', \'' + version + '\', \'' + userLang + '\', ' + numOfChapters + ');">' +
                shortNameToDisplay + '</a></td>';
            counter++;
            if ((counter % columns) == 0) {
                tableHTML += '</tr><tr style="height:30px">';
            }
        }
        tableHTML += '</tr></table>';
        if (additionalBooks) tableHTML += '<p style="color:brown">* Deuterocanonical or other books</p>';
        if (notSeenNT) $('#ot_table').append(tableHTML);
        else $('#nt_table').append(tableHTML);
    }

    function _buildBookHeaderAndSkeleton() {
         var html = '<div class="header">' +
            '<h4>' + __s.bible_book_name + '</h4>';
			if (step.util.getPassageContainer(step.util.activePassageId()).find(".resultsLabel").text() === "")
				html += '<div class="append">' +
					'<h6 id="appendMsg">Append the new passage to the current web page</h6>' +
					'<div class="onoffswitch2">' +
					'<input type="checkbox" name="onoffswitch2" class="onoffswitch2-checkbox" id="addpassageonoffswitch" onchange="addPassage()"/>' +
					'<label class="onoffswitch2-label" for="addpassageonoffswitch">' +
					'<span class="onoffswitch2-inner"></span>' +
					'<span class="onoffswitch2-switch"></span>' +
					'</label>' +
					'</div>' +
					'</div>';
            html += '</div>' +
            '<h5>Old Testament</h5>' +
            '<div id="ot_table"/>' +
            '<h5>New Testament</h5>' +
            '<div id="nt_table"/>' +
            '</div>';
		return html;
    }

    function __buildBookTableHeader(columns) {
        var columnPercent = Math.floor(100 / columns);
        html = '<table>' +
            '<colgroup>';
        for (var i = 0; i < columns; i++) {
            html += '<col span="1" style="width:' + columnPercent + '%;">';
        }
        html += '</colgroup>';
        html += '<tr style="height:30px">';
        return html;
    }

    function addPassage() {
        if (document.getElementById('addpassageonoffswitch').checked) {
            addInsteadOfReplace = true;
            $('#appendMsg').addClass('checked');
        }
        else {
            addInsteadOfReplace = false;
            $('#appendMsg').removeClass('checked');
        }
    }

    function goToPassage(osisID) {
        var activePassageData = step.util.activePassage().get("searchTokens") || [];
        var allVersions = "";
        var existingReferences = "";
        for (var i = 0; i < activePassageData.length; i++) {
            if (activePassageData[i].itemType == "version") {
                if (allVersions.length > 0) allVersions += "|version=";
                allVersions += activePassageData[i].item.shortInitials;
            }
            else if ((addInsteadOfReplace) && (activePassageData[i].itemType == "reference")) {
                existingReferences += "|reference=" + activePassageData[i].item.osisID;
            }
        }
        var url = VERSION + '=' + allVersions + existingReferences + '%7C' + REFERENCE + '=' + osisID;
        closeChapterSelect();
        console.log("navigateSearch from passage_selection.html: " + url)
        step.router.navigateSearch(url, true); // skip QFilter
    }

    function getChapters(bookOsisID, version, userLang, numOfChapters) {
        var url = SEARCH_AUTO_SUGGESTIONS + bookOsisID + "/limit%3D" + REFERENCE + "%7C" + VERSION + "%3D" + version + "%7C" + REFERENCE + "%3D" + bookOsisID + "%7C?lang=" + userLang;
        $('#pssgModalBackButton').show();
        if (numOfChapters > 0) {
            _buildChapterTable(null, bookOsisID, numOfChapters);
        }
        else {
            $.getJSON(url, function (data) {
                _buildChapterTable(data, bookOsisID, numOfChapters);
            });
        }
    }

	function _handleEnteredPassage(verifyOnly) {
		var userInput = $('textarea#enterYourPassage').val();
		userInput = userInput.replace(/[\n\r]/g, ' ').replace(/\t/g, ' ').replace(/\s\s/g, ' ').replace(/,,/g, ',');
		lastInput = userInput;
		if (verifyOnly) {
			var pos = userInput.lastIndexOf(",");
			if (pos > -1) userInput = userInput.substring(pos + 1);
		}
		userInput = userInput.replace(/^\s+/g, '');
		lastInputChecked = userInput;
		
		var url = SEARCH_AUTO_SUGGESTIONS + userInput + "/limit%3D" + REFERENCE + "%7C" + VERSION + "%3D" + version + "%7C?lang=" + userLang;
		$.getJSON(url, function (data) {
			if (data.length > 0) {
				if (data[0].suggestion.passage) {
					console.log(data);
					$('#userEnterPassageError').text("Program error: 1st element not false");
				}
				else if (!verifyOnly) goToPassage(data[0].suggestion.osisID);
			}
			else {
				var errorText = (lastInputChecked != "") ? errorText = ' for "' + lastInputChecked + '"' : "";
				$('#userEnterPassageError').text("No match" + errorText + ", please update the passage you entered.");
				$('textarea#enterYourPassage').focus();
				$('textarea#enterYourPassage').val(lastInput);
			}
		});
	}

	function _userEnterPassage() {
		$('#keyboardEntry').hide();
        $('#pssgModalBackButton').show();
		var html = '<h4>Type in your passage</h4>';
		if (step.util.getPassageContainer(step.util.activePassageId()).find(".resultsLabel").text() === "")
			html += '<div class="append">' +
				'<h6 id="appendMsg">Append the new passage to the current web page</h6>' +
				'<div class="onoffswitch2">' +
				'<input type="checkbox" name="onoffswitch2" class="onoffswitch2-checkbox" id="addpassageonoffswitch" onchange="addPassage()"/>' +
				'<label class="onoffswitch2-label" for="addpassageonoffswitch">' +
				'<span class="onoffswitch2-inner"></span>' +
				'<span class="onoffswitch2-switch"></span>' +
				'</label>' +
				'</div>' +
				'</div><br>';
		html += '<p>&nbsp;&nbsp;&nbsp;<b>Examples:</b>	Matt 6</p>' +
			'<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Isa 40:1-2</p>' +
			'<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;John 3:16, Rom 3:23, Rev 1:8</p><br><br>' +
			'<p>Enter passage(s):</p>' +
			'<textarea id="enterYourPassage" rows="1" style="font-size:16px; width: 80%;"></textarea>' + // size 16px so the mobile devices will not expand
			'<br><br>' +
			'<button type="button" onclick=_handleEnteredPassage(false)>Go to passage</button>&nbsp;' +
			'<span id="userEnterPassageError" style="color: red;"></span>';
		$('#bookchaptermodalbody').empty();
		$('#bookchaptermodalbody').append(html);
		$(function(){
			$("#bookchaptermodalbody").keypress(function(e){
				var code = (e.keyCode ? e.keyCode : e.which);
				if (code == 13) _handleEnteredPassage(false); // 13 is return
				else if (code == 44) _handleEnteredPassage(true); // 44 is ,
			}).keyup(function(e){
				var code = (e.keyCode ? e.keyCode : e.which);
				if ((code == 8) || (code == 46)) $('#userEnterPassageError').text(""); // 8 is backspace, 46 is .
			});
		});
		$('textarea#enterYourPassage').focus();
	}

    function _buildChapterTable(data, bookOsisID, numOfChapters) {
        var html = '<h4>' + __s.chapters_in_book + '</h4>' +
            '<table>' +
            '<colgroup>' +
            '<col span="1" style="width: 10%;">' +
            '<col span="1" style="width: 10%;">' +
            '<col span="1" style="width: 10%;">' +
            '<col span="1" style="width: 10%;">' +
            '<col span="1" style="width: 10%;">' +
            '<col span="1" style="width: 10%;">' +
            '<col span="1" style="width: 10%;">' +
            '<col span="1" style="width: 10%;">' +
            '<col span="1" style="width: 10%;">' +
            '<col span="1" style="width: 10%;">' +
            '</colgroup>' +
            '<tr style="height:30px">';

        var chapterNum = 0;
        var osisIDLink = "";
        if (numOfChapters > 0) {
            for (var i = 0; i < numOfChapters; i++) {
                chapterNum++;
                osisIDLink = (numOfChapters === 1) ? bookOsisID : bookOsisID + '.' + chapterNum;
                html += '<td><a href="javascript:goToPassage(\'' + osisIDLink + '\');">' + chapterNum + '</a></td>'
                if ((chapterNum > 9) && ((chapterNum % 10) == 0)) {
                    html += '</tr><tr style="height:30px">';
                }
            }
        }
        else {
            for (var i = 0; i < data.length; i++) {
                if (data[i].suggestion.sectionType == "PASSAGE") {
                    chapterNum++;
                    osisIDLink = data[i].suggestion.osisID;
                    html += '<td><a href="javascript:goToPassage(\'' + osisIDLink + '\');">' + chapterNum + '</a></td>'
                    if ((chapterNum > 9) && ((chapterNum % 10) == 0)) {
                        html += '</tr><tr style="height:30px">';
                    }
                }
            }
        }
        if (chapterNum === 1) goToPassage(osisIDLink); // If there is only one chapter, just go to it.
        html +=
            '</tr></table>' +
            '</div>';
        $('#bookchaptermodalbody').empty();
        $('#bookchaptermodalbody').append(html);
    }

    function closeChapterSelect() {
        $('#passageSelectionModal').modal('hide');
        $('#passageSelectionModal').modal({
            show: false
        });
        var element = document.getElementById('passageSelectionModal');
        if (element) element.parentNode.removeChild(element);
    }

    function goBackToPreviousPage() {
        $('#bookchaptermodalbody').empty();
        _displayListOfBooks();
    }

</script>
