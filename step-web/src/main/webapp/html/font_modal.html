<link rel="stylesheet" href="css/spectrum.css">
<script src="libs/spectrum.js"></script>
<script src="libs/tinycolor-min.js"></script>
<div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" onclick=closeFontSetting()>X</button>
</div>
<div class="modal-body" style="text-align:center">
    <table>
        <tr>
            <th style="width:70%">
            <th style="width:30%">
        </tr>
        <tr>
            <td>Font size</td>
            <td class="pull-right">
                <button class="btn btn-default btn-sm" type="button" title="Decrease font size" onclick="step.util.changeFontSize($('.passageOptionsGroup'), -1)"><span style="font-size:8px;line-height:12px">A</span></button>
                <button class="btn btn-default btn-sm" type="button" title="Increase font size" onclick="step.util.changeFontSize($('.passageOptionsGroup'), 1)"><span style="font-size:10px;line-height:12px;font-weight:bold">A</span></button>
            </td>
        </tr>
        <tr>
            <td>Color</td>
            <td class="pull-right">
                <input id="inClrStrongFont" type="color" class="nInptC" value="#17758F"/>
            </td>
        </tr>

    </table>
    <br>
	<p style="text-align:left;font-size:18px">Examples for the selected color</p>
	<p class="passageContent" style="color:var(--strong_color)">Text with color</p>
	<p class="passageContent primaryLightBg">Highlighted text (general)</p>
	<p class="passageContent lexiconFocus">Highlighted for lexicon</p>
	<p class="passageContent relatedWordEmphasisHover">Highlighted for related text</p>
	
    <div class="footer">
        <button class="stepButton pull-right" data-dismiss="modal" onclick=closeFontSetting()><label>Exit</label></button>
        <button class="stepButton pull-right" onclick=setColor()><label>Reset Color</label></button>
    </div>
    <br>
</div>
<script>
    $(document).ready(function () {
      var color = step.settings.get("highlight_color");
      if (!((typeof color === "string") && (color.length == 7))) color = "#17758F";
      $('#inClrStrongFont').spectrum({
        color: color,
        clickoutFiresChange: false,
	    showPalette: true,
		palette: [
			['rgb(23, 117, 143);', 'green'],
			['rgb(136, 47, 61);', 'rgb(110, 11, 116);']
		],
        change: function(color) {
            var currentClrPicker = $('#inClrStrongFont').spectrum('get').toHexString();
            setColor(currentClrPicker);
        },
        show: function(color) {
            var currentClrPicker = $('#inClrStrongFont').spectrum('get').toHexString();
            var color = step.settings.get("highlight_color");
            if (!((typeof color === "string") && (color.length == 7))) color = "#17758F";
            if (color != currentClrPicker) setColor(currentClrPicker);
        }
      });
    })
    
    function closeFontSetting() {
        $('.sp-container').remove(); // The color selection tool is not totally removed so manually remove it. 08/19/2019
        step.util.closeModal("fontSettings");
        $('.modal-backdrop.in').remove(); // The color selection tool is not totally removed so manually remove it. 05/15/2021
    }
    
    function setColor(baseColor) {
        if (!((typeof baseColor === "string") && (baseColor.length == 7) && (baseColor.substr(0,1) === "#"))) baseColor = "#17758F";
		
		var ratio = calculateRatio(baseColor);
		console.log("ratio " + ratio);
		if (ratio > 0.3) {
			alert("Color selected is not dark enough and can be difficult to read.  Please select a darker color.");
			return;
		}	
		
		var t = tinycolor(baseColor);
		var hsl = t.toHsl();
		var colorH = hsl["h"];
		var colorS = hsl["s"] * 100;
		var colorL = hsl["l"] * 100;
		var rootVar = document.querySelector(':root');
		rootVar.style.setProperty('--highlight_color',baseColor);
        step.settings.save({"highlight_color":baseColor});
		
        var desaturate = colorS - 40;
        var desColor = tinycolor("hsl(" + colorH + ", " + desaturate + "%, " + colorL + "%)");
        var desHsl = desColor.toHsl();
		var desColorH = desHsl["h"];
		var desColorS = desHsl["s"] * 100;
		var desColorL = desHsl["l"] * 100;   

		var lighten = desColorL + 10;
        var lightColor = tinycolor("hsl(" + desColorH + ", " + desColorS + "%, " + lighten + "%)");
        var lightHex = lightColor.toHexString();
		console.log("Set strong_color " + lightHex);
		rootVar.style.setProperty('--strong_color',lightHex);
		step.settings.save({"strong_color":lightHex});

        desaturate = colorS - 50;
        desColor = tinycolor("hsl(" + colorH + ", " + desaturate + "%, " + colorL + "%)");
        desHsl = desColor.toHsl();
		desColorH = desHsl["h"];
		desColorS = desHsl["s"] * 100;
		desColorL = desHsl["l"] * 100;   

		lighten = desColorL + 50;
        lightColor = tinycolor("hsl(" + desColorH + ", " + desColorS + "%, " + lighten + "%)");
        lightHex = lightColor.toHexString();
		rootVar.style.setProperty('--lexiconFocusColour',lightHex);
		step.settings.save({"lexiconFocusColour":lightHex});
		
		lighten = colorL + 55;
        lightColor = tinycolor("hsl(" + colorH + ", " + colorS + "%, " + lighten + "%)");
        lightHex = lightColor.toHexString();
		rootVar.style.setProperty('--relatedWordBackground',lightHex);
		step.settings.save({"relatedWordBackground":lightHex});
    }
	
	function calculateRatio(selectedColor) {
	  // calculate the relative luminance
	  var colorLuminance = tinycolor(selectedColor).getLuminance();
	  var whiteLuminance = 1;

	  // calculate the color contrast ratio
	  var ratio = ((colorLuminance + 0.05) / (whiteLuminance + 0.05));
	  return ratio;
	}
	
</script>
