<div class="modal-header">
	<button id="srchModalBackButton" type="button" style="border:none;float:left;font-size:16px" onclick=goBackTo1stPage()><i class="glyphicon glyphicon-arrow-left"></i></button>
	<button type="button" class="close" data-dismiss="modal" onclick=closeChapterSelect()>X</button>
</div>
<div id="bookchaptermodalbody" class="modal-body">
</div>
<div class="footer">
</div>
<script>
    var version = "ESV_th";
    var userLang = "en";
    var addInsteadOfReplace = false;
	var searchOnASpecificType = "";
	var searchTypeCode = [TEXT_SEARCH, GREEK_MEANINGS, GREEK, HEBREW_MEANINGS, HEBREW, SUBJECT_SEARCH, MEANINGS];
    $(document).ready(function () {
        userLang = step.state.language() || "en-US";
        var html = _buildSearchHeaderAndSkeleton();
        $('#bookchaptermodalbody').append(html);
		$('#srchModalBackButton').hide();
		$(function(){
			$("#bookchaptermodalbody").keyup(function(e){
				_handleEnteredPassage();
			});
		});
		$('textarea#enterYourSearch').focus();
    });

    function goBackTo1stPage() {
		searchOnASpecificType = "";
		$('#srchModalBackButton').hide();
		_handleEnteredPassage();
    }

    function addPassage() {
        if (document.getElementById('addpassageonoffswitch').checked) {
            addInsteadOfReplace = true;
            $('#appendMsg').addClass('checked');
        }
        else {
            addInsteadOfReplace = false;
            $('#appendMsg').removeClass('checked');
        }
    }

    function _buildSearchHeaderAndSkeleton() {
		var typeDesc = ["This wording in the Bible", "Greek word that can be translated as", "Greek word", "Hebrew word that can be translated as", "Hebrew word", "Verses with the subject of", "English words that can be translated as"];
		var searchTypeTitle = ["Search the Bible with the text you entered", "Search as a Greek word", "Search as a Hebrew word", "Search the subjects in the Bible", "Search definition of words with the text you entered"];
		var html = '<div class="header">' +
            '<h4>Enter search word</h4>' + // should internationalize this
//            '<div class="append">' +
//            '<h6 id="appendMsg">Append to the search</h6>' +
//            '<div class="onoffswitch2">' +
//            '<input type="checkbox" name="onoffswitch2" class="onoffswitch2-checkbox" id="addpassageonoffswitch" onchange="addPassage()"/>' +
//            '<label class="onoffswitch2-label" for="addpassageonoffswitch">' +
//            '<span class="onoffswitch2-inner"></span>' +
//            '<span class="onoffswitch2-switch"></span>' +
//            '</label>' +
//            '</div>' +
//            '</div>' +
            '</div>' +
			'<textarea id="enterYourSearch" rows="1" style="font-size:16px; width: 80%;"></textarea>' + // size 16px so the mobile devices will not expand
            '<h4 id=promptusertoselectsearch></h4>' +
            '<div id="search_table">' +
			'<table border="1">' +
            '<colgroup>' +
            '<col span="1" style="width:39%;">' +
			'<col span="1" style="width:61%;">' +
			'</colgroup>' +
			'<tr style="height:30px">' +
			'<tr>' +
			'<th scope="col">Type of search</th>' +
			'<th scope="col">Possible search word(s)</th>' +
			'</tr>';
		for (var i = 0; i < typeDesc.length; i ++) {
			html += '<tr style="height:40px;" class="select2-results-dept-0 select2-result select2-result-selectable select-' + searchTypeCode[i] + '">' +
				'<td class="select2-results-dept-0 select2-result select2-result-selectable select-' + searchTypeCode[i] + '" title="' + searchTypeTitle[i] + '" style="font-size:12px;text-align:left">' + typeDesc[i] + '</td>' +
				'<td id="searchResults' + searchTypeCode[i] + '" style="font-size:12px;text-align:left"></td>' +
				'</tr>';
		}
		html += '</table>' +
            '</div>';
		return html;
    }

	function _handleEnteredPassage(limitType) {
		var userInput = $('textarea#enterYourSearch').val();
		userInput = userInput.replace(/[\n\r]/g, ' ').replace(/\t/g, ' ').replace(/\s\s/g, ' ').replace(/,,/g, ',').replace(/^\s+/g, '');
		if ((userInput.length > 1) || ((userLang.toLowerCase().startsWith("zh")) && (userInput.length > 0))) {
			var url;
			if ((typeof limitType === "undefined") && (searchOnASpecificType == ""))
				url = SEARCH_AUTO_SUGGESTIONS + userInput + "/" + VERSION + "%3D" + version + "%7C?lang=" + userLang;
			else {
				if (typeof limitType !== "undefined") searchOnASpecificType = limitType;
				else limitType = searchOnASpecificType;
				$('#srchModalBackButton').show();
				url = SEARCH_AUTO_SUGGESTIONS + userInput + "/" + VERSION + "%3D" + version + "%7C" + LIMIT + "%3D" + limitType + "%7C?lang=" + userLang;
			}
			$.getJSON(url, function (data) {
				var searchResultsToDisplay = [];
				for (var i = 0; i < searchTypeCode.length; i++) {
					searchResultsToDisplay.push("");
				}
				for (var i = 0; i < data.length; i++) {
					var searchType = data[i].itemType;
					var searchResultIndex = searchTypeCode.indexOf(searchType);
					switch(searchType) {
                        case GREEK:
						case GREEK_MEANINGS:
                        case HEBREW:
                        case HEBREW_MEANINGS:
                        case MEANINGS:
                        case SUBJECT_SEARCH:
						case TEXT_SEARCH:
							var text2Display = "";
							if (data[i].grouped) {
								if (typeof data[i].extraExamples !== "undefined") {
									for (var k = 0; k < data[i].extraExamples.length; k++) {
										if (k > 0) text2Display += ", ";
										if ((searchType === GREEK) || (searchType === HEBREW))
											text2Display += data[i].extraExamples[k].stepTransliteration;
										else if ((searchType === GREEK_MEANINGS) || (searchType === HEBREW_MEANINGS) || (searchType === MEANINGS))
											text2Display += data[i].extraExamples[k].gloss;
										else if (searchType === SUBJECT_SEARCH)
											text2Display += data[i].extraExamples[k].value;
									}
									text2Display += ", etc...";
									searchResultsToDisplay[searchResultIndex] += '<a style="padding:0px;" href="javascript:_handleEnteredPassage(\'' + searchType + '\')">' + text2Display + "</a>";
								}
								else searchResultsToDisplay[searchResultIndex] += 'There are ' + data[i].count + ' more options.  Keep typing to see them.';
							}
							else {
								var str2Search = "";
								if (searchType === SUBJECT_SEARCH) {
									text2Display = data[i].suggestion.value;
									str2Search = text2Display;
								}
								else if (searchType === MEANINGS) {
									text2Display = data[i].suggestion.gloss;
									str2Search = text2Display;
								}
								else if (searchType === TEXT_SEARCH) {
									text2Display = data[i].suggestion.text;
									str2Search = text2Display;
								}
								else {
									text2Display = data[i].suggestion.gloss + ' (' + data[i].suggestion.stepTransliteration +
										' - ' + data[i].suggestion.matchingForm + ')';
									str2Search = data[i].suggestion.strongNumber;
									searchType = 'strong';
								}
								searchResultsToDisplay[searchResultIndex] += '<a style="padding:0px;" href="javascript:goSearch(\'' + searchType + '\',\'' + str2Search + '\')">' + text2Display + "</a>";
							}
							break;
						case REFERENCE:
							break;
                        default:
                            alert("Unknown result: " + searchType);
							console.log(data[i]);
                            break;
					}
				}
				for (l = 0; l < searchResultsToDisplay.length; l++) {
					$('#searchResults' + searchTypeCode[l]).html(searchResultsToDisplay[l]);
					if (typeof limitType === "undefined") $('.select-' + searchTypeCode[l]).show()
					else if (searchResultsToDisplay[l].length > 0) $('.select-' + searchTypeCode[l]).show()
					else $('.select-' + searchTypeCode[l]).hide()
				}
			});
		}
		else {
			for (l = 0; l < searchTypeCode.length; l++) {
				$('#searchResults' + searchTypeCode[l]).text("");
			}
		}
	}

    function closeChapterSelect() {
        $('#searchSelectionModal').modal('hide');
        $('#searchSelectionModal').modal({
            show: false
        });
        var element = document.getElementById('searchSelectionModal');
        element.parentNode.removeChild(element);
    }

    function goSearch(searchType, searchWord) {
        var activePassageData = step.util.activePassage().get("searchTokens") || [];
        var allVersions = "";
        var existingReferences = "";
        for (var i = 0; i < activePassageData.length; i++) {
            if (activePassageData[i].itemType == "version") {
                if (allVersions.length > 0) allVersions += "|version=";
                allVersions += activePassageData[i].item.shortInitials;
            }
            else if ((addInsteadOfReplace) && (activePassageData[i].itemType == "reference")) {
//                existingReferences += "|reference=" + activePassageData[i].item.osisID;
            }
        }
        var url = 'version=' + allVersions + existingReferences + '|' + searchType + '=' + searchWord;
        closeChapterSelect();
        console.log("navigateSearch from passage_selection.html: " + url)
        step.router.navigateSearch(url, true);
    }

    function getChapters(bookOsisID, version, userLang, numOfChapters) {
        var url = SEARCH_AUTO_SUGGESTIONS + bookOsisID + "/limit%3Dreference%7Cversion%3D" + version + "%7Creference%3D" + bookOsisID + "%7C?lang=" + userLang;
        console.log('num of chapters: ' + numOfChapters);
        if (numOfChapters > 0) {
            _buildChapterTable(null, bookOsisID, numOfChapters);
        }
        else {
            $.getJSON(url, function (data) {
                _buildChapterTable(data, bookOsisID, numOfChapters);
            });
        }
    }
</script>
