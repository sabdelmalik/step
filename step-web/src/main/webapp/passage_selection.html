<div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" onclick=closeBookSelect()>X</button>
</div>
<div class="modal-body">
	<form style="font-size:16px">
		<select name="add_or_replace" id="add_or_replace">
			<option value="replace">Select new passage</option>
			<option value="add">Add a passage to current selection</option>
		</select>
	</form>
	<h4>Books</h4>
	<h5 style="background-color:#dcdcdc;">Old Testament</h5>
	<div id="ot_table"/>
	<h5 style="background-color:#dcdcdc;">New Testament</h5>
	<div id="nt_table"/>
</div>
</div>
<script>
	$( document ).ready(function() {
		var data = step.util.activePassage().get("searchTokens") || [];
		var version = "ESV_th";
		for (var i = 0; i < data.length; i++) {
			if (data[i].itemType == "version") {
				version = data[i].item.initials;
				break;
			}
		}
		var userLang = step.state.language() || "en-US";
		var url = SEARCH_AUTO_SUGGESTIONS + "%20%20/examples%3Dreference%7Climit%3Dreference%7Cversion%3D" + version + "%7C?lang=" + userLang;
		$.getJSON(url, function( data ) {
			var counter = 0;
			var notSeenNT = true;
			var browserWidth = $(window).width();
			var columns = 7;
			if (browserWidth < 1100) {
				columns = 6;
				if (browserWidth < 800) columns = 5;
			}
			var tableHTML = _buildTableHeader(columns);
			//var ot = "Gen Exod Lev Num Deut Josh Judg Ruth 1Sam 2Sam 1Kgs 2Kgs 1Chr 2Chr Ezra Neh Esth Job Ps Prov Eccl Song Isa Jer Lam Ezek Dan Hos Joel Amos Obad Jonah Mic Nah Hab Zeph Hag Zech Mal";
			var nt = "Matt Mark Luke John Acts Rom 1Cor 2Cor Gal Eph ï»¿Phil Col 1Thess 2Thess 1Tim 2Tim Titus Phlm Heb Jas 1Pet 2Pet 1John 2John 3John Jude Rev";
			for (var i = 0; i < data.length; i++) {
				currentOsisID = data[i].suggestion.osisID;
				newTestament = (nt.indexOf(currentOsisID) > -1);
				if ((newTestament) && (notSeenNT)) {
					notSeenNT = false;
					counter = 0; // reset counter for NT table
					tableHTML += '</tr></table>';
					$('#ot_table').append(tableHTML);
					tableHTML = _buildTableHeader(columns);
				}
				tableHTML += '<td title="' + data[i].suggestion.fullName + '">' +
						'<a style="color:blue;font-size:14px;" href="javascript:getChapters(\'' + currentOsisID + '\', \'' + version + '\', \'' + userLang + '\');">' +
						data[i].suggestion.shortName.replaceAll(" ", "").substr(0, 4) + '</a></td>';
				counter ++;
				if ((counter % columns) == 0) {
					tableHTML += '</tr><tr style="height:30px">';
				}
			}
			tableHTML += '</tr></table>';
			$('#nt_table').append(tableHTML);
		});
	});

	function _buildTableHeader(columns) {
		var columnPercent = Math.floor(100 / columns);
		var tableHtml = '<table style="width:95%;margin-left:auto;margin-right:auto;color:blue;font-size:14px;">' +
				'<colgroup>';
		for (var i = 0; i < columns; i++) {
			tableHtml += '<col span="1" style="width:' + columnPercent + '%;">';
		}
		tableHtml += '</colgroup>';
		tableHtml += '<tr style="height:30px">';
		return tableHtml;
	}
	function goToPassage(osisID, addToSelection) {
		var activePassageData = step.util.activePassage().get("searchTokens") || [];
		var allVersions = "";
		var existingReferences = "";
		for (var i = 0; i < activePassageData.length; i++) {
			if (activePassageData[i].itemType == "version") {
				if (allVersions.length > 0) allVersions += "|version=";
				allVersions += activePassageData[i].item.shortInitials;
			}
			else if ((addToSelection) && (activePassageData[i].itemType == "reference")) {
				existingReferences += "|reference=" + activePassageData[i].item.osisID;
			}
		}
		var url = 'version=' + allVersions + existingReferences + '|reference=' + osisID;
		closeChapterSelect();
		console.log("navigateSearch from passage_selection.html: " + url)
		step.router.navigateSearch(url);
	}

	function getChapters(osisID, version, userLang) {
		var url = SEARCH_AUTO_SUGGESTIONS + osisID + "/limit%3Dreference%7Cversion%3D" + version + "%7Creference%3D" + osisID + "%7C?lang=" + userLang;
		var addPassagetoCurrentSelection = ($('#add_or_replace').val() === "add");
		$.getJSON(url, function( data ) {
			closeBookSelect();
			if (document.getElementById("chapterSelectionModal")) {
				var element = document.getElementById('chapterSelectionModal');
				element.parentNode.removeChild(element);
			}
			var html =
			'<div id="chapterSelectionModal" class="modal fade" role="dialog" data-id="my_id_value">' +
				'<div class="modal-dialog">' +
					'<div class="modal-content">' +
						'<div class="modal-header">' +
							'<button type="button" class="close" data-dismiss="modal">X</button>' +
							'<h4 class="modal-title">Chapters</h4>' +
						'</div>' +
						'<div class="modal-body">' +
							'<table style="width:95%;margin-left:auto;margin-right:auto;">' +
							'<colgroup>' +
									'<col span="1" style="width: 10%;">' +
									'<col span="1" style="width: 10%;">' +
									'<col span="1" style="width: 10%;">' +
									'<col span="1" style="width: 10%;">' +
									'<col span="1" style="width: 10%;">' +
									'<col span="1" style="width: 10%;">' +
									'<col span="1" style="width: 10%;">' +
									'<col span="1" style="width: 10%;">' +
									'<col span="1" style="width: 10%;">' +
									'<col span="1" style="width: 10%;">' +
								'</colgroup>' +
								'<tr style="height:30px">';

			var chpCounter = 0;
			for (var i = 0; i < data.length; i++) {
				if (data[i].suggestion.sectionType == "PASSAGE") {
					html += '<td><a style="color:blue;font-size:14px;" href="javascript:goToPassage(\'' + data[i].suggestion.osisID + '\', ' + addPassagetoCurrentSelection + ');">' + i + '</a></td>'
					chpCounter ++;
					if ((chpCounter > 9) && ((chpCounter % 10) == 0)) {
						html += '</tr><tr style="height:30px">';
					}
				}
			}
			html +=
						'</tr></table>' +
						'</div>' +
					'</div>' +
				'</div>' +
			'</div>';

			var chapterSelectDiv = $(html);
			chapterSelectDiv.appendTo("body");
			$('#chapterSelectionModal').modal('show');
		});
	}

	function closeBookSelect() {
		$('#bookSelectionModal').modal('hide');
		$('#bookSelectionModal').modal({
			show: false
		});
		var element = document.getElementById('bookSelectionModal');
		element.parentNode.removeChild(element);
	}

	function closeChapterSelect() {
		$('#chapterSelectionModal').modal('hide');
		$('#chapterSelectionModal').modal({
			show: false
		});
		var element = document.getElementById('chapterSelectionModal');
		element.parentNode.removeChild(element);
	}

</script>